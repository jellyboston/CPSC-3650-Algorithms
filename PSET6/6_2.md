### Part 2
#### Prove `update` function for bidirectional edges

##### Definitions

**Capacity constraint.**  
For every directed edge $(u,v)$ in $G$,
$$
0 \le f(u,v) \le c(u,v),
$$
where $c(u,v)$ is the edge capacity and $f(u,v)$ is the current flow.  
This ensures that flow on any edge never exceeds its capacity and never becomes negative.

**Single-direction flow constraint.**  
Even when both $(u,v)$ and $(v,u)$ exist, flow may go in *at most one direction*:
$$
f(u,v) > 0 \Rightarrow f(v,u) = 0.
$$
Equivalently,
$$
f(u,v),f(v,u) = 0
$$
for every vertex pair $(u,v)$.

##### WTS
The new `update()` function for bidirectional edges satisfies both constraints.

##### Note
By the Ford–Fulkerson invariant, we may assume that before each call to `update()`, 
the current flow satisfies the **conservation constraint** at all vertices 
(except the source and sink). We do not need to prove that this property 
is maintained, since it is ensured by the overall algorithm and the structure 
of our code.


##### Precondition
Before `update()` is called, assume the flow satisfies the capacity and single-direction constraints.

##### Step 1: Positive flow in the opposite direction
**Capacity constraint.**  
We first set 
$$
c = \min(b,\,f(v,u)).
$$
Because $c \le f(v,u)$, the call `reverse.add_flow(-c)` decreases (never increases) the reverse flow.  
Hence the new flow satisfies
$$
f'(v,u) = f(v,u) - c \ge 0
$$
and remains bounded above by its capacity $c(v,u)$.  
Therefore, the capacity constraint is preserved on both directions.

**Single-direction constraint.**  
At this point we only *decrease* the flow in the reverse edge, and we have not yet added any flow in the forward direction.  
Thus after Step 1, either the reverse flow is unchanged or reduced—possibly to zero—while the forward flow is still the same.  
It is therefore impossible for both directions to carry positive flow simultaneously.

##### Step 2: Update flow in the forward direction

Let $r = b - c \ge 0$ be the remaining augmentation budget after Step 1 (the cancellation step), where
$$
c = \min\{b,\; f(v,u)\}.
$$
Define
$$
\text{safe\_add} \;=\; \min\{r,\; \operatorname{residual}(u,v)\}.
$$

**Capacity constraint.**  
By definition of residual capacity,
$$
\operatorname{residual}(u,v) \;=\; c(u,v) - f(u,v).
$$
We set
$$
f'(u,v) \;=\; f(u,v) + \text{safe\_add},\\\\
\quad
f'(v,u) \text{ unchanged in this substep.}
$$

Because $\text{safe\_add} \le \operatorname{residual}(u,v) = c(u,v) - f(u,v)$, we get
$$
f'(u,v) \;=\; f(u,v) + \text{safe\_add}\\\
\;\le\; f(u,v) + \bigl(c(u,v)-f(u,v)\bigr)\\
\;=\; c(u,v),
$$
and clearly $f'(u,v) \ge 0$. Thus $0 \le f'(u,v) \le c(u,v)$, so capacity is preserved.

**Single-direction flow constraint.**  
We consider two exhaustive cases based on Step 1 (the cancellation step):

- **Case A: $f(v,u) \ge b$.**  
  Then $c = b$ and $r = b - c = 0$, so $\text{safe\_add} = 0$ and we do **not** increase $f(u,v)$ at all.  
  After Step 1 we have $f'(v,u) = f(v,u) - b \ge 0$, and $f'(u,v) = f(u,v)$.  
  Therefore, if $f'(v,u) > 0$ then necessarily $f'(u,v)$ did not increase in this step, so both cannot be positive because they were not both positive before (precondition).

- **Case B: $f(v,u) < b$.**  
  Then $c = f(v,u)$, so cancellation makes $f'(v,u) = f(v,u) - c = 0$ after Step 1.  
  Now $r = b - c > 0$, and we may add forward flow by $\text{safe\_add} \le r$.  
  Hence after the forward update we have $f'(u,v) \ge 0$ and **still** $f'(v,u) = 0$.  
  Thus only one direction can be positive.

In both cases, after Step 2 at most one of $f'(u,v)$ and $f'(v,u)$ is positive. Hence the single-direction flow constraint is preserved.